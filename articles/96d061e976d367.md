---
title: "FinOps with IaC: Infracost"
emoji: "ğŸ¦"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["terraform", "finops", "iac", "infracost"]
published: false
---
Infracost[^2] ã«ã¤ã„ã¦ã€‚

https://www.infracost.io/

```bash: breakdown
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”³â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ Project                                                         â”ƒ Monthly Cost â”ƒ
â”£â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•‹â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”«
â”ƒ danny-yamamoto/terraform-example-gke/env/dev/firewall           â”ƒ $0.00        â”ƒ
â”ƒ danny-yamamoto/terraform-example-gke/env/dev/gke                â”ƒ $408         â”ƒ
â”ƒ danny-yamamoto/terraform-example-gke/env/dev/instance_templates â”ƒ $53          â”ƒ
â”ƒ danny-yamamoto/terraform-example-gke/env/dev/network            â”ƒ $0.00        â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”»â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
```

ç¾è·ã«ãŠã„ã¦ cloud ã®åˆ©ç”¨ã¯å®šç€ã—ã¦ããŸã€‚

ä¸€æ–¹ã§ cost ã®ç®¡ç†ãŒå•é¡Œã ã¨æ„Ÿã˜ã¦ã„ã‚‹ã€‚

2019å¹´ã® cloud åˆ©ç”¨é–‹å§‹æ™‚ã‹ã‚‰ cost ã¯ pricing calculatorï¼ˆcalculatorï¼‰[^1] ã§æ¦‚ç®—ã‚’è¨ˆç®—ã—ã¦ã„ã‚‹ã€‚

å€‹äººçš„ã«ã¯ calculator ã«å…¥åŠ›ã™ã‚‹ã®ã¯åŠ¹ç‡çš„ã§ã¯ãªã„ã¨æ€ã†ã€‚

IaC ãŒé€²ã‚“ã§ã„ã‚‹ã®ã« cost è¨ˆç®—ã‚„ç®¡ç†ã¯ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãªã®ã‹ï¼Ÿã¨ã€‚

## tl;dr
- Infracost ã¯ cost ã‚’ HCL ã«åŸºã¥ã„ã¦ç®—å‡ºã™ã‚‹ã€‚
- Infracost ã¯ Terraform ã® official partner[^3] ã¨ãªã£ã¦ã„ã‚‹ãŸã‚ HashiCorp ã®ãƒ©ã‚¤ã‚»ãƒ³ã‚¹å¤‰æ›´[^4]ã®å½±éŸ¿ã¯ç„¡ã„ï¼Ÿ
- æ§‹æˆå¤‰æ›´æ™‚ã®å·®åˆ†ã‚’ç¢ºèªã™ã‚‹ã«ã¯ `breakdown` æ™‚ã« JSON `--out-file` ã‚’ä½œæˆã™ã‚‹ã€‚
- auto scaling ã‚’ä½¿ã†å ´åˆã‚„å¸¸æ™‚èµ·å‹•ã—ãªã„ resource ã¯ calculator ãŒå¿…è¦ã¨ãªã‚‹ã€‚å®Ÿè¡Œæ™‚é–“ã§è¨ˆç®—ã™ã‚‹ã€‚

## Star History
ç«¶åˆã¨ã„ã†ç«¶åˆãŒå­˜åœ¨ã—ãªã„ãŸã‚ã‹ GitHub star ã¯ä¼¸ã³ç¶šã‘ã¦ã„ã‚‹ã€‚
ãã—ã¦ Infracost ã¯ HashiCorp ã® official partner[^3]ã€‚

> Infracost is an official HashiCorp partner. We work together to ensure that Infracost can be used alongside Terraform Cloud/Enterprise and integrated into your workflow.
> 
> Infracostã¯HashiCorpã®å…¬å¼ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã§ã™ã€‚Infracost ã‚’ Terraform Cloud/Enterprise ã¨å…±ã«ä½¿ç”¨ã—ã€ãŠå®¢æ§˜ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«çµ±åˆã§ãã‚‹ã‚ˆã†ã«å”åŠ›ã—ã¦ã„ã¾ã™ã€‚

[![Star History Chart](https://api.star-history.com/svg?repos=infracost/infracost&type=Date)](https://star-history.com/#infracost/infracost&Date)

## Get started

https://www.infracost.io/docs/

### Install Infracost
local ã« CLI ã‚’ install ã™ã‚‹ã€‚
```bash
vscode âœ /workspaces/terraform-example-gke (main) $ curl -fsSL https://raw.githubusercontent.com/infracost/infracost/master/scripts/install.sh | sh
Downloading version latest of infracost-linux-arm64...

Validating checksum for infracost-linux-arm64...

Moving /tmp/infracost-linux-arm64 to /usr/local/bin/infracost (you might be asked for your password due to sudo)

Completed installing Infracost v0.10.31
vscode âœ /workspaces/terraform-example-gke (main) $ infracost --version
Infracost v0.10.31
```

### Get API key
äº‹å‰ã« Infracost ã®ã‚µã‚¤ãƒˆã§ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã—ã¦ãŠãã€‚Free ã‚’ä½¿ç”¨ã—ãŸã€‚
```bash
vscode âœ /workspaces/terraform-example-gke (main) $ infracost auth login
We're redirecting you to our log in page, please complete that,
and return here to continue using Infracost.

If the redirect doesn't work, either:
- Use this URL:
    https://dashboard.infracost.io/login?cli_port=aaaaa&cli_state=a-b-c-d-e&cli_version=v0.10.31&os=linux&utm_source=cli

- Or log in/sign up at https://dashboard.infracost.io, copy your API key
    from Org Settings and run `infracost configure set api_key MY_KEY`

Waiting...

The API key was saved to /home/vscode/.config/infracost/credentials.yml

Your account has been authenticated. Run Infracost on your Terraform project by running:

  infracost breakdown --path=.
```

### Show Cost estimate breakdown
`main.tf` ã® directory ã§ command ã‚’å®Ÿè¡Œã™ã‚‹ã€‚
```bash
vscode âœ /workspaces/terraform-example-gke (main) $ cd env/dev/
vscode âœ /workspaces/terraform-example-gke/env/dev (main) $ infracost breakdown --path .
2024-01-05T10:18:59Z INF Enabled policies V2
2024-01-05T10:18:59Z INF Enabled tag policies
Evaluating Terraform directory at .
Detected Terraform project at firewall
Detected Terraform project at gke
Detected Terraform project at network
Detected Terraform project at instance_templates
2024-01-05T10:18:59Z INF Starting: Downloading Terraform modules
2024-01-05T10:18:59Z INF Starting: Downloading Terraform modules
2024-01-05T10:18:59Z INF Starting: Downloading Terraform modules
2024-01-05T10:18:59Z INF Starting: Downloading Terraform modules
2024-01-05T10:18:59Z INF Starting: Evaluating Terraform directory
2024-01-05T10:18:59Z INF Starting: Evaluating Terraform directory
2024-01-05T10:18:59Z INF Starting: Evaluating Terraform directory
2024-01-05T10:18:59Z INF Starting: Evaluating Terraform directory
2024-01-05T10:18:59Z WRN Input values were not provided for following Terraform variables: "variable.GOOGLE_CREDENTIALS", "variable.PROJECT_ID". Use --terraform-var-file or --terraform-var to specify them.
2024-01-05T10:19:00Z WRN Input values were not provided for following Terraform variables: "variable.GOOGLE_CREDENTIALS", "variable.PROJECT_ID". Use --terraform-var-file or --terraform-var to specify them.
2024-01-05T10:19:00Z WRN Input values were not provided for following Terraform variables: "variable.GOOGLE_CREDENTIALS", "variable.PROJECT_ID". Use --terraform-var-file or --terraform-var to specify them.
2024-01-05T10:19:01Z WRN Input values were not provided for following Terraform variables: "variable.GOOGLE_CREDENTIALS", "variable.PROJECT_ID". Use --terraform-var-file or --terraform-var to specify them.
2024-01-05T10:19:01Z INF Starting: Retrieving cloud prices to calculate costs

Project: danny-yamamoto/terraform-example-gke/env/dev/firewall
Module path: firewall

 Name           Monthly Qty  Unit  Monthly Cost 
                                                
 Project total                            $0.00 

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Project: danny-yamamoto/terraform-example-gke/env/dev/gke
Module path: gke

 Name                                                      Monthly Qty  Unit   Monthly Cost 
                                                                                            
 module.gke.google_container_cluster.k8s                                                    
 â”œâ”€ Cluster management fee                                         730  hours        $73.00 
 â””â”€ default_pool                                                                            
    â”œâ”€ Instance usage (Linux/UNIX, on-demand, e2-medium)           730  hours        $31.38 
    â””â”€ Standard provisioned storage (pd-standard)                  100  GB            $5.20 
                                                                                            
 module.gke.google_container_node_pool.pool-hoge                                            
 â”œâ”€ Instance usage (Linux/UNIX, on-demand, e2-standard-4)          730  hours       $125.51 
 â””â”€ Standard provisioned storage (pd-standard)                     100  GB            $5.20 
                                                                                            
 module.gke.google_container_node_pool.prod-default-pool                                    
 â”œâ”€ Instance usage (Linux/UNIX, on-demand, e2-medium)              730  hours        $31.38 
 â””â”€ Standard provisioned storage (pd-standard)                     100  GB            $5.20 
                                                                                            
 module.gke.google_container_node_pool.prod-pool-hoge                                       
 â”œâ”€ Instance usage (Linux/UNIX, on-demand, e2-standard-4)          730  hours       $125.51 
 â””â”€ Standard provisioned storage (pd-standard)                     100  GB            $5.20 
                                                                                            
 Project total                                                                      $407.57 

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Project: danny-yamamoto/terraform-example-gke/env/dev/instance_templates
Module path: instance_templates

 Name                                              Monthly Qty  Unit  Monthly Cost 
                                                                                   
 module.instance_templates.google_compute_disk.pv                                  
 â””â”€ Standard provisioned storage (pd-standard)           1,024  GB          $53.25 
                                                                                   
 Project total                                                              $53.25 

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Project: danny-yamamoto/terraform-example-gke/env/dev/network
Module path: network

 Name           Monthly Qty  Unit  Monthly Cost 
                                                
 Project total                            $0.00 

 OVERALL TOTAL                          $460.82 
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
12 cloud resources were detected:
âˆ™ 5 were estimated, 4 of which include usage-based costs, see https://infracost.io/usage-file
âˆ™ 7 were free, rerun with --show-skipped to see details

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”³â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ Project                                                         â”ƒ Monthly Cost â”ƒ
â”£â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•‹â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”«
â”ƒ danny-yamamoto/terraform-example-gke/env/dev/firewall           â”ƒ $0.00        â”ƒ
â”ƒ danny-yamamoto/terraform-example-gke/env/dev/gke                â”ƒ $408         â”ƒ
â”ƒ danny-yamamoto/terraform-example-gke/env/dev/instance_templates â”ƒ $53          â”ƒ
â”ƒ danny-yamamoto/terraform-example-gke/env/dev/network            â”ƒ $0.00        â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”»â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
vscode âœ /workspaces/terraform-example-gke/env/dev (main) $ 
```

## What if the configuration changes?
`diff` option ã§æ§‹æˆå¤‰æ›´å‰å¾Œã®å·®é¡ã‚’ç¢ºèªã§ãã‚‹ã€‚ä»¥ä¸‹ã®ã¨ãŠã‚Š official ã® calculator ã®é‡‘é¡å·®åˆ†ã¨åŒã˜ã€‚

- calculator

Cost Estimate Summary As of Jan 7, 2024 â€¢ 4:55â€¯PM
| |Total estimated cost|
|----|----|
|e2-standard-4|$126.55|
|e2-standard-8|$252.06|
||**$125.51**|

- Infracost
    - `e2-standard-4` â†’ `e2-standard-8` ã«å¤‰æ›´ã€‚äºˆæ¸¬ã¯ **$126** ã®é‡‘é¡ã‚¢ãƒƒãƒ—ã€‚
```bash: diff
vscode âœ /workspaces/terraform-example-gke/env/dev (main) $ infracost diff --path . --compare-to infracost-base.json
2024-01-07T07:54:07Z INF Enabled policies V2
2024-01-07T07:54:07Z INF Enabled tag policies
Evaluating Terraform directory at .
Detected Terraform project at firewall
Detected Terraform project at gke
Detected Terraform project at instance_templates
Detected Terraform project at network
2024-01-07T07:54:07Z INF Starting: Downloading Terraform modules
2024-01-07T07:54:07Z INF Starting: Downloading Terraform modules
2024-01-07T07:54:07Z INF Starting: Downloading Terraform modules
2024-01-07T07:54:07Z INF Starting: Downloading Terraform modules
2024-01-07T07:54:07Z INF Starting: Evaluating Terraform directory
2024-01-07T07:54:07Z INF Starting: Evaluating Terraform directory
2024-01-07T07:54:07Z INF Starting: Evaluating Terraform directory
2024-01-07T07:54:07Z INF Starting: Evaluating Terraform directory
2024-01-07T07:54:07Z WRN Input values were not provided for following Terraform variables: "variable.GOOGLE_CREDENTIALS", "variable.PROJECT_ID". Use --terraform-var-file or --terraform-var to specify them.
2024-01-07T07:54:08Z WRN Input values were not provided for following Terraform variables: "variable.GOOGLE_CREDENTIALS", "variable.PROJECT_ID". Use --terraform-var-file or --terraform-var to specify them.
2024-01-07T07:54:09Z WRN Input values were not provided for following Terraform variables: "variable.GOOGLE_CREDENTIALS", "variable.PROJECT_ID". Use --terraform-var-file or --terraform-var to specify them.
2024-01-07T07:54:09Z WRN Input values were not provided for following Terraform variables: "variable.GOOGLE_CREDENTIALS", "variable.PROJECT_ID". Use --terraform-var-file or --terraform-var to specify them.
2024-01-07T07:54:09Z INF Starting: Retrieving cloud prices to calculate costs

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Project: danny-yamamoto/terraform-example-gke/env/dev/gke
Module path: gke

~ module.gke.google_container_node_pool.prod-pool-hoge
  +$126 ($131 â†’ $256)

    ~ Instance usage (Linux/UNIX, on-demand, e2-standard-4 â†’ e2-standard-8)
      +$126 ($126 â†’ $251)

Monthly Cost change for danny-yamamoto/terraform-example-gke/env/dev/gke (Module path: gke)
Amount:  +$126 ($408 â†’ $533)
Percent: +31%

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Key: ~ changed, + added, - removed

12 cloud resources were detected:
âˆ™ 5 were estimated, 4 of which include usage-based costs, see https://infracost.io/usage-file
âˆ™ 7 were free, rerun with --show-skipped to see details

Infracost estimate: Monthly Cost will increase by $126 â†‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”³â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”³â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
â”ƒ Project                                            â”ƒ Cost change  â”ƒ New monthly Cost â”ƒ
â”£â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•‹â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•‹â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”«
â”ƒ danny-yamamoto/terraform-example-gke/env/dev/gke   â”ƒ +$126 (+31%) â”ƒ $533             â”ƒ
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”»â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”»â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
vscode âœ /workspaces/terraform-example-gke/env/dev (main) $
```

ä»Šå›ã®ã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰ã€‚

https://github.com/danny-yamamoto/terraform-example-gke

Infracost ã«é–¢ã™ã‚‹èª¿æŸ»ã¯ä»¥ä¸Šã€‚

[^1]: https://cloud.google.com/products/calculator?hl=ja
[^2]: https://www.infracost.io/
[^3]: https://www.infracost.io/docs/integrations/terraform_cloud_enterprise/
[^4]: https://www.hashicorp.com/blog/hashicorp-adopts-business-source-license
